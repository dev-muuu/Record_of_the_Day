# 2022.03.17

## Fragment ì¢…ë£Œ í›„ ê²°ê³¼ê°’ ì „ë‹¬ in Navigation

### # ****NavBackStackEntry****

- NavControllerì˜ back stackì— ìˆëŠ” entry ì§€ì¹­

---

### # ****SavedStateHandle****

- ViewModelë¡œ ì „í•´ì§„ Handle
    - ì‹¤ì‹œê°„ ë°ì´í„° ë°”ì¸ë”© ê°€ëŠ¥ ëœ»í•¨
- get ë˜ëŠ” getLiveDataì— ì˜í•´ ë°˜í™˜ë˜ëŠ” LiveData observe í†µí•´ ì½ì„ ìˆ˜ ìˆìŒ
- set ë˜ëŠ” getLiveDataì— ì˜í•´ ì„¸íŒ…ë˜ëŠ” LiveData observe í†µí•´ ì‘ì„±í•  ìˆ˜ ìˆìŒ

- **getLiveData(String key)**
    - keyì™€ ê´€ë ¨ëœ LiveData ë°˜í™˜

<img src="image/2022_03_17/6.png" width="50%"/><img src="image/2022_03_17/2.png" width="50%"/>

ì™¼ìª½(AddressResultFragment)ì—ì„œ íŠ¹ì • ì¥ì†Œ ì„ íƒì‹œ, ì˜¤ë¥¸ìª½(MakeMeetingFragment)ê³¼ ê°™ì´ í•´ë‹¹ fragment ì¢…ë£Œ í›„, ì•½ì† ì¥ì†Œì— ì¥ì†Œì´ë¦„ì´ ê¸°ì…ë˜ê²Œ ë¨

---

```java
//AddressResultFragment
@Override
public void onBindViewHolder(ViewHolder viewHolder, final int position) {
    viewHolder.setData(placeList.get(position));
    viewHolder.itemView.setOnClickListener(v->{
        Navigation.findNavController(getView())
                .getBackStackEntry(R.id.makeMeetingFragment)
                .getSavedStateHandle()
                .set("result",viewHolder.getPlaceName());
        Navigation.findNavController(getView()).popBackStack();
    });
}
```

<aside>

    ğŸ’¡  > getBackStackEntryì€ back stack ìì²´ë¥¼ ê°€ë¦¬í‚¤ëŠ”ê²Œ ì•„ë‹ˆë¼, entry ì˜ë¯¸

    > backStackEntry í†µí•´ savedStateHandle ê°€ì ¸ì˜´

    â†’ savedStateHandle í†µí•´ LiveData ì ‘ê·¼ ê°€ëŠ¥í•´ì§

    â†’ AddressResultFragment ì¢…ë£Œ í›„ MakeMeetingFragmentì—ì„œ

</aside>

---

```java
//MakeMeetingBottomSheet
Navigation.findNavController(getView()).getCurrentBackStackEntry().getSavedStateHandle()
                .getLiveData("result").observe(getViewLifecycleOwner(), o -> {
            onViewStateRestored(bundle);
            binding.meetingPlace.setText(o.toString());
}
```

<aside>

    ğŸ’¡  > MakeMeetingBottomSheetì— ì„¤ì •í•œ savedStateHandleì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” MakeMeetingBottomSheetì˜ viewCreated ë©”ì„œë“œì— currentBackStackEntryë¥¼ í†µí•´ LiveDataë¥¼ ê°€ì ¸ì˜¤ë©°, observe/get ì½”ë“œë¥¼ ì¶”ê°€í•˜ë©´ ë¨

</aside>

---

<aside>

    â— BackStackEntryë¥¼ í†µí•´ Navigation Fragmentì˜ ê²°ê³¼ê°’ì„ ì´ì „ Fragmentì— ì „ë‹¬í•  ìˆ˜ ìˆë‹¤!

</aside>

ì¶”ê°€ë¡œ,

```java
<fragment
        android:id="@+id/addressSearchFragment"
        android:name="com.example.zatch.navigation.chat.AddressSearchFragment"
        android:label="AddressSearchFragment"
        tools:layout="@layout/fragment_find_place_search">
        <action
            android:id="@+id/action_addressSearchFragment_to_addressResultFragment"
            app:destination="@id/addressResultFragment"
            app:popUpTo="@id/makeMeetingFragment"
            app:popUpToInclusive="false"/>
    </fragment>
```

<aside>

    â—  > Aì—ì„œ Bë¡œ ì´ë™í•  ë•Œ, Bì—ì„œ pop ì´í›„ ë„ì°©ì§€ ì„¤ì •ì€ Aâ†’B actionì—ì„œ ì„¤ì •í•´ì£¼ë©´ ë¨ 

    â†’ ì´ë•Œ popUpToë¡œ ì„¤ì •í•˜ë©°, Aì „ì— Cê°€ ì¡´ì¬í•˜ê³ , Bì—ì„œ Cë¡œ ëŒì•„ê°„ë‹¤ë©´ popUpTo ì„¤ì • í•„ìˆ˜

    â†’ if ì„¤ì •X, AddressResultFragment ì¢…ë£Œ í›„ MakeMeetingFragmentìœ¼ë¡œ ê°€ëŠ”ê²Œ ì•„ë‹ˆë¼ AddressSearchFragmentë¡œ ê°€ê²Œë¨

</aside>

<img src="image/2022_03_17/7.png" width="50%"/>

ì›ì— ë‘˜ëŸ¬ì‹¸ì¸ í™”ì‚´í‘œê°€ popUpToë¥¼ ì˜ë¯¸..?í•˜ëŠ” ë“¯ í•˜ë‹¤

@ ì°¸ê³ 

[https://jaeyeong951.medium.com/navigation-componentì˜-ê²°ê³¼ê°’-ì „ë‹¬í•˜ê¸°-c10e795d6858](https://jaeyeong951.medium.com/navigation-component%EC%9D%98-%EA%B2%B0%EA%B3%BC%EA%B0%92-%EC%A0%84%EB%8B%AC%ED%95%98%EA%B8%B0-c10e795d6858)

---

## Fragment state Save and Restore

<aside>

    ğŸ’¥ BottomSheet ì•½ì† ì¡ê¸° Fragmentì—ì„œ ì•½ì† ì‹œê°„ì„ ë¯¸ë¦¬ ì„¸íŒ…í•´ë‘ê³ , ì´í›„ ì•½ì† ì¥ì†Œë¥¼ ì„ íƒí•  ê²½ìš° ì•½ì† ì‹œê°„ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ëŠ” ë¬¸ì œ ë°œìƒ

    â†’ ì•½ì† ì¥ì†Œë¥¼ ì„¤ì •í•  ë•ŒëŠ” navigationì— ì˜í•´ ê¸°ì¡´ fragmentê°€ ë‹¤ë¥¸ fragmentë¡œ ì „í™˜ë˜ëŠ” ìƒí™©

    â‡’ ê¸°ì¡´ ë°ì´í„° ê°’ ìœ ì§€ë˜ë„ë¡ í•´ì•¼í•¨

</aside>

!<img src="image/2022_03_17/1.png" width="50%"/><img src="image/2022_03_17/2.png" width="50%"/>

ì™¼ìª½ìƒíƒœì˜€ë‹¤ê°€, ì¥ì†Œ ì„ íƒ ì´í›„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë¨(ì•½ì† ì‹œê°„ ì •ë³´ ì‚¬ë¼ì§€ëŠ” í˜„ìƒ)

---

<aside>

    ğŸ’¡ **ë¬¸ì œ í•´ê²° ê³¼ì •**

    â†’ í™”ë©´ ì „í™˜ì´ ì¼ì–´ë‚  ë•Œë§ˆë‹¤ ìƒˆë¡­ê²Œ fragmentë¥¼ ìƒì„±í•˜ëŠ” navigation ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ë¬¸ì œì ì´ê¸° ë•Œë¬¸ì— navigation ë¬¸ì„œì—ì„œ í•´ê²°ë°©ì•ˆì„ ì°¾ìœ¼ë ¤ê³  í•´ë´„

    â†’ ë¬¸ì„œì—ì„œ stateì™€ ê´€ë ¨ëœ ë©”ì„œë“œ ë°œê²¬
    (ì²˜ìŒ ë°œê²¬í–ˆì„ ë•ŒëŠ” navcontrollerì˜ stateë¥¼ ì €ì¥í•˜ëŠ” ê±´ì¤„ ëª°ëìŒ.. fragmentì˜ view ë°ì´í„° ì €ì¥ì— ì •ì‹ ì´ íŒ”ë ¤ì„œ ë‹¹ì—°íˆ ì´ ë¶€ë¶„ì„ í•´ê²°í•´ì¤„ê±°ë¼ê³  ìƒê°í–ˆì—ˆìŒ)

    â†’ saveState, restoreState í™œìš© ë°©ë²• ê³ ë¯¼í•˜ë©´ì„œ ë‹¤ë¥¸ ë¬¸ì„œë“¤ ì°¾ì•„ë³´ë‹¤ê°€ onViewStateRestoredì™€ onSaveInstanceState ë©”ì„œë“œ ë°œê²¬

    â†’ ì½”ë“œ êµ¬í˜„

    â†’ í•´ê²°!

</aside>

<img src="image/2022_03_17/4.png" width="50%"/>

<img src="image/2022_03_17/5.png" width="50%"/>

- **onSaveInstanceState(Bundle outState)**
    1. Activity
    - onCreate ë˜ëŠ” onRestoreInstanceStateì—ì„œ ìƒíƒœë¥¼ ë³µì›í•  ìˆ˜ ìˆë„ë¡ kill ë˜ê¸° ì „ì— í˜¸ì¶œë¨
    - ë‚˜ì¤‘ì— ëŒì•„ì™”ì„ ë•Œ, stateë¥¼ íšŒë³µí•  ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•´ì„œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ
    - if A ìœ„ë¡œ Bê°€ ì‹¤í–‰ë  ì˜ˆì •, AëŠ” ë‚˜ì¤‘ì— ìì‹ ì´ ë‹¤ì‹œ ì‹¤í–‰ë  ìƒí™©ì„ ëŒ€ë¹„í•´ stateë¥¼ ì €ì¥í•´ë†“ìŒ
    
    1. Fragment
    - ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì¬êµ¬ì„±ë  ìˆ˜ ìˆë„ë¡, í˜„ì¬ ìƒíƒœë¥¼ ì €ì¥í•˜ë„ë¡ ìš”ì²­í•˜ê¸° ìœ„í•´ í˜¸ì¶œ
    - í›„ì— ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë˜ê³ , onCreate, onCreateView, onActivityCreatedì—ì„œ ì´ìš© ê°€ëŠ¥
    - onDestroy ì „ì— ì•„ë¬´ë•Œë‚˜ í˜¸ì¶œ ê°€ëŠ¥
    
- **onViewStateRestored (Bundle savedInstanceState)**
    - Fragment method
    - ì €ì¥ëœ ëª¨ë“  ìƒíƒœê°€ fragmentì˜ view ê³„ì¸µìœ¼ë¡œ ë³µì›ë˜ë©´ í˜¸ì¶œë¨
    - ì €ì¥ëœ ìƒíƒœë¡œ ì´ˆê¸°í™”í•˜ëŠ”ë° ì‚¬ìš©ë¨

<aside>

    â— ìœ„ì˜ í•¨ìˆ˜ í˜¸ì¶œí•˜ê¸°ë§Œ í•œë‹¤ê³  ì•Œì•„ì„œ í•´ì£¼ëŠ”ê²Œ ì•„ë‹ˆë‹¤.. í•„ìš”í•œ ë¶€ë¶„ë“¤ ì €ì¥í•˜ê³  ë³µêµ¬ ì‹œí‚¤ëŠ”ê±´ ë‚˜ì˜ ëª«..

</aside>

---

```java
binding.meetingPlace.setOnClickListener(v->{
            onSaveInstanceState(bundle);
            Navigation.findNavController(getView()).navigate(R.id.action_makeMeetingFragment_to_addressSearchFragment);        
});       
```

<aside>

    ğŸ’¡  > meetingPlaceëŠ” ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ìœ¼ë¡œ, í•´ë‹¹ ë²„íŠ¼ì„ ëˆ„ë¥¼ ê²½ìš° ë‹¤ë¥¸ fragmentë¡œ ëŒ€ì²´ë˜ê²Œ ë¨

    â†’ viewê°€ ì‚¬ë¼ì§€ê¸° ì „(navigate ë°œìƒí•˜ê¸° ì „)ì— onSaveInstanceState ë©”ì„œë“œ í˜¸ì¶œ í†µí•´ ê¸°ì¡´ ìƒíƒœ ì €ì¥

</aside>

---

```java
Navigation.findNavController(getView()).getCurrentBackStackEntry().getSavedStateHandle()
                .getLiveData("result").observe(getViewLifecycleOwner(), o -> {
            onViewStateRestored(bundle);
            binding.meetingPlace.setText(o.toString());
```

<aside>

    ğŸ’¡  > ì£¼ì†Œ ê²€ìƒ‰ fragmentë¡œ ì „í™˜ë˜ì–´ ìˆë‹¤ê°€, í•´ë‹¹ fragment ì¢…ë£Œ í›„ ë‹¤ì‹œ ëŒì•„ì˜¬ ë•Œ onViewStateRestoredë¥¼ í˜¸ì¶œí•´ ê¸°ì¡´ ìƒíƒœë¡œ ë³µêµ¬ì‹œí‚¤ëŠ” ì½”ë“œ

</aside>

---

```java
@Override
    public void onSaveInstanceState(@NonNull Bundle outState) {
        super.onSaveInstanceState(outState);
        outState.putString("month",binding.makeMeetingMonth.getText().toString());
        outState.putString("date",binding.makeMeetingDate.getText().toString());
        outState.putString("hour",binding.makeMeetingHourText.getText().toString());
        outState.putString("minute",binding.makeMeetingMinuteText.getText().toString());
        outState.putBoolean("alarm",binding.alarmSwitch.isChecked());
    }

    @Override
    public void onViewStateRestored(@Nullable Bundle savedInstanceState) {
        super.onViewStateRestored(savedInstanceState);
        if(savedInstanceState != null) {
            binding.makeMeetingMonth.setText(savedInstanceState.getString("month"));
            binding.makeMeetingDate.setText(savedInstanceState.getString("date"));
            binding.makeMeetingHourText.setText(savedInstanceState.getString("hour"));
            binding.makeMeetingMinuteText.setText(savedInstanceState.getString("minute"));
            binding.alarmSwitch.setChecked(savedInstanceState.getBoolean("alarm"));
        }
    }
```

<aside>

    ğŸ’¡  > onViewStateRestoredì™€ onSaveInstanceStateëŠ” Fragmentì—ì„œ ì œê³µí•˜ëŠ” ë©”ì„œë“œë¡œ Fragment ë‚´ì—ì„œ ììœ ë¡­ê²Œ í˜¸ì¶œí•˜ê³ , í•„ìš”í•  ê²½ìš° overrideí•´ ì½”ë“œë¥¼ ì¶”ê°€í•´ ë™ì‘ì„ ì¶”ê°€í•˜ë©´ ë¨

</aside>

---

<aside>

    ğŸ’¥ onViewStateRestoredì—ì„œ NullPointerException ë¬¸ì œ ë°œìƒ

</aside>

<img src="image/2022_03_17/9.png" width="50%"/>

<img src="image/2022_03_17/8.png" width="50%"/>

<aside>

    ğŸ’¡  > onViewStateRestoredëŠ” onActivityCreated ì™€ onStart ì‚¬ì´ì—ì„œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì—, null ê°’ ë°œìƒí•  ìˆ˜ ë°–ì— ì—†ìŒ

    â†’ ê¸°ì¡´ fragment ìƒíƒœ ì €ì¥ì´ onStart ì´í›„ì¸ onResume ë‹¨ê³„ì—ì„œ ì‚¬ìš©ìì˜ ìƒí˜¸ì‘ìš©ì„ í†µí•´ ì´ë¤„ì§€ê¸° ë•Œë¬¸

    â†’ onSaveInstanceStateë¥¼ í˜¸ì¶œí•˜ê¸° ì „ê¹Œì§€ëŠ” null ê°’ ìƒíƒœ

    â‡’ null ê°’ ê²€ì‚¬ë¥¼ í†µí•´ nullì´ ì•„ë‹ ë•Œë§Œ(state ì €ì¥ëœ ìƒíƒœ) ê¸°ì¡´ ìƒíƒœ ë³µêµ¬ ì‘ì—… ë˜ë„ë¡ ì½”ë“œ ìˆ˜ì •

</aside>

---

<img src="image/2022_03_17/3.png" width="50%"/>

ë¬¸ì œ í•´ê²°!